import{l as D}from"./leaflet-src-10abcd12.js";import"./leaflet.markercluster-src-b6ba4176.js";import{g as G}from"./SubscriptionBanner.vue_vue_type_style_index_0_scoped_7aa2f15c_lang-67917262.js";import{_ as H}from"./_plugin-vue_export-helper-c27b6911.js";import{m as E,z as W,K as J,q as P,o as g,d as _,A as R,D as Z,g as j,b as v,e as U,h as w,k as O,u as L,F as I,j as S,t as V,L as q,v as B,l as K}from"./app-59f66305.js";const Q={__name:"DataMapDisplay",props:{mapCenterCoordinates:{type:Array,default:()=>[42.3601,-71.0589]},dataPointsToDisplay:{type:Array,default:()=>[]},externalIdFieldProp:{type:String,default:"id"},zoomLevel:{type:Number,default:13},mapConfiguration:Object,dataTypeConfigProp:Object,clusterRadiusProp:{type:Number,default:80}},emits:["marker-data-point-clicked","map-initialized-internal"],setup(d,{expose:k,emit:p}){delete D.Icon.Default.prototype._getIconUrl;const s=d,i=p,N=`leaflet-map-${Math.random().toString(36).substring(2,9)}`,o=E(null),x=E({}),r=E(new Map),f=(t,l)=>{var T,z;const h="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",y=(T=s.dataTypeConfigProp)==null?void 0:T.dynamicIcon;if(y!=null&&y.enabled&&y.textField){const M=l[y.textField]||"0";return parseInt(M,10)>0?D.divIcon({html:`<span>${M}</span>`,className:`leaflet-div-icon ${y.className||"report-value-icon"}`,iconSize:[30,30]}):D.icon({iconUrl:h,iconSize:[1,1]})}const F=((z=s.mapConfiguration)==null?void 0:z.dataPointModelConfig)||{},b=Object.values(F).find(M=>M.displayTitle===t);if(!b)return D.icon({iconUrl:h,iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],className:"default-div-icon"});const $=G(l),C=$.iconUrlOverride||h,A=$.className||b.displayTitle.toLowerCase().replace(/\s+/g,"-")+"-div-icon";return D.icon({iconUrl:C,iconRetinaUrl:C,iconSize:[38,38],iconAnchor:[19,38],popupAnchor:[0,-38],shadowUrl:!1,className:A.trim()})},u=t=>function(l){const h=l.getChildCount();let y="marker-cluster";const F=t==="Unknown"||!t?"mixed":t.toLowerCase().replace(/\s+/g,"-");return y+=` cluster-${F}`,h<10?y+=" marker-cluster-small":h<100?y+=" marker-cluster-medium":y+=" marker-cluster-large",D.divIcon({html:`<div><span>${h}</span></div>`,className:y,iconSize:D.point(40,40)})},c=()=>{o.value||(o.value=R(D.map(N,{}).setView(s.mapCenterCoordinates,s.zoomLevel)),s.mapConfiguration&&console.log("Map configuration:",s.mapConfiguration),D.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(o.value),i("map-initialized-internal",o.value),a(s.dataPointsToDisplay))},m=t=>{const l=(y,F=!1)=>{let b=F?'<div style="padding-left: 15px; border-left: 1px solid #eee; margin-top: 5px;">':"";for(const $ in y)if(Object.prototype.hasOwnProperty.call(y,$)){const C=$.replace(/_/g," ").replace(/\b\w/g,T=>T.toUpperCase());let A=y[$];typeof A=="object"&&A!==null&&!Array.isArray(A)?(b+=`<div><strong>${C}:</strong>`,b+=l(A,!0),b+="</div>"):Array.isArray(A)?(b+=`<div><strong>${C}:</strong>`,A.forEach(T=>{b+=l(T,!0)}),b+="</div>"):b+=`<div><strong>${C}:</strong> ${A}</div>`}return b+=F?"</div>":"",b};let h='<div style="max-height: 250px; overflow-y: auto; font-size: 0.9em; line-height: 1.4;">';return h+=l(t),h+="</div>",h},n=()=>{Object.values(x.value).forEach(t=>{o.value.hasLayer(t)&&o.value.removeLayer(t)}),x.value={}},a=t=>{o.value&&(Object.values(x.value).forEach(l=>{l.clearLayers()}),r.value.clear(),t.forEach(l=>{const h=parseFloat(l.latitude||l.lat),y=parseFloat(l.longitude||l.long||l.lng),F=l.alcivartech_model||"Unknown_Model",b=l.alcivartech_type||"Unknown";if(!isNaN(h)&&!isNaN(y)){if(!x.value[F]){const T=R(D.markerClusterGroup({maxClusterRadius:s.clusterRadiusProp,iconCreateFunction:u(b)}));o.value.addLayer(T),x.value[F]=T}const $=f(b,l),C=R(D.marker([h,y],{icon:$,alcivartechType:b}));C.bindPopup(m(l)),C.on("click",()=>{i("marker-data-point-clicked",l)}),x.value[F].addLayer(C);const A=l[s.externalIdFieldProp];A!==void 0&&r.value.set(String(A),C)}}))},e=(t,l)=>{const h=t[l||s.externalIdFieldProp],y=r.value.get(String(h));if(y&&o.value){const F=y.getLatLng();o.value.setView(F,Math.max(o.value.getZoom(),15)),Z(()=>{y.openPopup()})}};return W(()=>{c()}),J(()=>{o.value&&(Object.values(x.value).forEach(t=>{o.value.hasLayer(t)&&o.value.removeLayer(t)}),x.value={},o.value.remove(),o.value=null)}),P(()=>s.dataPointsToDisplay,t=>{a(t)},{deep:!0}),P(()=>s.mapCenterCoordinates,t=>{o.value&&t&&t.length===2&&o.value.setView(t,s.zoomLevel)},{deep:!0}),P(()=>s.clusterRadiusProp,t=>{o.value&&(n(),a(s.dataPointsToDisplay))}),k({getMapInstance:()=>o.value,panToAndOpenPopup:e}),(t,l)=>(g(),_("div",{id:N,class:"h-full w-full"}))}},Ne=H(Q,[["__scopeId","data-v-229bef72"]]),Y={class:"p-4 border rounded-md shadow-sm bg-white"},X={key:0,class:"text-gray-500"},ee={key:1,class:"text-gray-500"},te={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},ae={key:0,class:"flex flex-col"},ne=["for"],le=["id"],se={key:0,class:"flex flex-col md:col-span-2 lg:col-span-3"},re=["for"],ie=["id","onUpdate:modelValue","placeholder"],oe={class:"flex flex-col"},de=["for"],ue=["id"],ce={class:"flex flex-col"},me=["for"],pe=["id"],fe=["for"],ye=["type","id","onUpdate:modelValue","placeholder"],ve=["id","onUpdate:modelValue"],ge={value:""},_e=["value"],he={key:2,class:"max-h-40 overflow-y-auto border rounded-md p-2"},be=["id","value","onUpdate:modelValue"],xe=["for"],Fe=["id","onUpdate:modelValue"],Ae=["id","onUpdate:modelValue"],$e={__name:"GenericFiltersControl",props:{filterFieldsDescription:{type:[String,Array,Object],default:()=>[]},initialFilters:{type:Object,default:()=>({})},dateField:String,dataType:String,isReadOnly:{type:Boolean,default:!1}},emits:["filters-updated"],setup(d,{emit:k}){const p=d,s=k,i=E({}),N=j(()=>p.dateField?p.dateField.replace(/_/g," ").replace(/\b\w/g,n=>n.toUpperCase()):""),o=j(()=>{if(!p.filterFieldsDescription)return[];try{let n=p.filterFieldsDescription;return typeof p.filterFieldsDescription=="string"&&(n=JSON.parse(p.filterFieldsDescription)),Array.isArray(n)?n:(console.warn("filterFieldsDescription was successfully parsed but is not an array. Received:",n,"Original prop:",p.filterFieldsDescription),[])}catch(n){return console.error("Failed to parse filterFieldsDescription. Expected a valid JSON string representing an array of filter objects, or an array/object directly. Error:",n,"Received prop:",p.filterFieldsDescription),[]}}),x=()=>{var a,e,t;const n={start_date:((a=p.initialFilters)==null?void 0:a.start_date)||"",end_date:((e=p.initialFilters)==null?void 0:e.end_date)||""};p.isReadOnly||(n.limit=((t=p.initialFilters)==null?void 0:t.limit)||1e3),o.value.forEach(l=>{p.initialFilters&&p.initialFilters.hasOwnProperty(l.name)?l.type==="boolean"?n[l.name]=String(p.initialFilters[l.name]):n[l.name]=p.initialFilters[l.name]:l.type==="multiselect"?n[l.name]=[]:(l.type,n[l.name]="")}),i.value=n};W(()=>{x()}),P(()=>[p.filterFieldsDescription,p.initialFilters],()=>{x()},{deep:!0});const r=()=>{const n={};for(const a in i.value){const e=i.value[a],t=o.value.find(l=>l.name===a);t&&t.type==="boolean"?e==="true"?n[a]=!0:e==="false"&&(n[a]=!1):e!==""&&e!==null&&!(Array.isArray(e)&&e.length===0)&&(n[a]=e)}s("filters-updated",{...n})},u=((n,a)=>{let e;return function(...t){const l=this;clearTimeout(e),e=setTimeout(()=>n.apply(l,t),a)}})(()=>{r()},300),c=()=>{r()},m=()=>{const n={limit:1e3};o.value.forEach(a=>{a.type==="multiselect"?n[a.name]=[]:(a.type,n[a.name]="")}),p.dateField&&(n.start_date="",n.end_date=""),i.value={...n},s("filters-updated",{...n})};return(n,a)=>(g(),_("div",Y,[a[7]||(a[7]=v("h4",{class:"text-lg font-semibold mb-3"},"Filters",-1)),o.value.length===0&&!d.dateField&&d.isReadOnly?(g(),_("div",X,"No filters available for this data type.")):U("",!0),o.value.length===0&&!d.dateField&&!d.isReadOnly&&i.value.limit===void 0?(g(),_("div",ee,"No filters available for this data type.")):U("",!0),v("div",te,[d.isReadOnly?U("",!0):(g(),_("div",ae,[v("label",{for:`limit_${d.dataType}`,class:"font-medium mb-1 text-sm"},"Record Limit",8,ne),w(v("input",{type:"number",id:`limit_${d.dataType}`,"onUpdate:modelValue":a[0]||(a[0]=e=>i.value.limit=e),onInput:a[1]||(a[1]=(...e)=>L(u)&&L(u)(...e)),class:"p-2 border rounded-md text-sm",placeholder:"e.g., 1000"},null,40,le),[[O,i.value.limit,void 0,{number:!0}]])])),(g(!0),_(I,null,S(o.value,e=>(g(),_(I,{key:e.name},[e.name==="search_term"?(g(),_("div",se,[v("label",{for:`filter_${e.name}_${d.dataType}`,class:"font-medium mb-1 text-sm"},V(e.label),9,re),w(v("input",{type:"text",id:`filter_${e.name}_${d.dataType}`,"onUpdate:modelValue":t=>i.value[e.name]=t,onInput:a[2]||(a[2]=(...t)=>L(u)&&L(u)(...t)),class:"p-2 border rounded-md text-sm",placeholder:e.placeholder||`Enter ${e.label.toLowerCase()}`},null,40,ie),[[O,i.value[e.name]]])])):U("",!0)],64))),128)),d.dateField?(g(),_(I,{key:1},[v("div",oe,[v("label",{for:`start_date_${d.dataType}`,class:"font-medium mb-1 text-sm"},"Start Date ("+V(N.value)+")",9,de),w(v("input",{type:"date",id:`start_date_${d.dataType}`,"onUpdate:modelValue":a[3]||(a[3]=e=>i.value.start_date=e),onChange:r,class:"p-2 border rounded-md text-sm"},null,40,ue),[[O,i.value.start_date]])]),v("div",ce,[v("label",{for:`end_date_${d.dataType}`,class:"font-medium mb-1 text-sm"},"End Date ("+V(N.value)+")",9,me),w(v("input",{type:"date",id:`end_date_${d.dataType}`,"onUpdate:modelValue":a[4]||(a[4]=e=>i.value.end_date=e),onChange:r,class:"p-2 border rounded-md text-sm"},null,40,pe),[[O,i.value.end_date]])])],64)):U("",!0),(g(!0),_(I,null,S(o.value.filter(e=>e.name!=="search_term"&&(d.isReadOnly||e.name!=="limit")),e=>(g(),_("div",{key:e.name,class:"flex flex-col"},[v("label",{for:`filter_${e.name}_${d.dataType}`,class:"font-medium mb-1 text-sm"},V(e.label),9,fe),e.type==="text"||e.type==="string"||e.type==="number"?w((g(),_("input",{key:0,type:e.type==="number"?"number":"text",id:`filter_${e.name}_${d.dataType}`,"onUpdate:modelValue":t=>i.value[e.name]=t,onInput:a[5]||(a[5]=(...t)=>L(u)&&L(u)(...t)),class:"p-2 border rounded-md text-sm",placeholder:e.placeholder||`Enter ${e.label.toLowerCase()}`},null,40,ye)),[[q,i.value[e.name]]]):e.type==="select"?w((g(),_("select",{key:1,id:`filter_${e.name}_${d.dataType}`,"onUpdate:modelValue":t=>i.value[e.name]=t,onChange:r,class:"p-2 border rounded-md text-sm"},[v("option",ge,"All "+V(e.label),1),(g(!0),_(I,null,S(e.options,t=>(g(),_("option",{key:t.value||t,value:t.value||t},V(t.label||t),9,_e))),128))],40,ve)),[[B,i.value[e.name]]]):e.type==="multiselect"&&e.options?(g(),_("div",he,[(g(!0),_(I,null,S(e.options,t=>(g(),_("div",{key:t.value||t,class:"flex items-center"},[w(v("input",{type:"checkbox",id:`filter_${e.name}_${t.value||t}_${d.dataType}`,value:t.value||t,"onUpdate:modelValue":l=>i.value[e.name]=l,onChange:r,class:"mr-2"},null,40,be),[[K,i.value[e.name]]]),v("label",{for:`filter_${e.name}_${t.value||t}_${d.dataType}`,class:"text-sm"},V(t.label||t),9,xe)]))),128))])):e.type==="boolean"?w((g(),_("select",{key:3,id:`filter_${e.name}_${d.dataType}`,"onUpdate:modelValue":t=>i.value[e.name]=t,onChange:r,class:"p-2 border rounded-md text-sm"},a[6]||(a[6]=[v("option",{value:""},"Any",-1),v("option",{value:"true"},"Yes",-1),v("option",{value:"false"},"No",-1)]),40,Fe)),[[B,i.value[e.name]]]):e.type==="date"?w((g(),_("input",{key:4,type:"date",id:`filter_${e.name}_${d.dataType}`,"onUpdate:modelValue":t=>i.value[e.name]=t,onChange:r,class:"p-2 border rounded-md text-sm"},null,40,Ae)),[[O,i.value[e.name]]]):U("",!0)]))),128))]),v("div",{class:"mt-4 flex space-x-2"},[v("button",{onClick:c,class:"p-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600"},"Apply Filters"),v("button",{onClick:m,class:"p-2 bg-gray-300 text-gray-700 rounded-md text-sm hover:bg-gray-400"},"Clear Filters")])]))}};function Ve(d,k,p){if(!d||!Array.isArray(d))return[];if(!k||typeof k!="object")return d;let s=[...d];const{dateField:i,searchableColumns:N=[],filterFieldsDescription:o=[]}=p||{},x=Object.entries(k).filter(([r,f])=>f!==null&&f!==""&&!(Array.isArray(f)&&f.length===0));for(const[r,f]of x)if(r!=="limit"){if(r==="search_term"&&typeof f=="string"&&f.trim()!==""&&N.length>0){const u=f.toLowerCase().trim();s=s.filter(c=>N.some(m=>{const n=c[m];return n&&String(n).toLowerCase().includes(u)}))}else if(r==="start_date"&&i){const u=new Date(f);if(!isNaN(u.getTime())){u.setHours(0,0,0,0);const c=k.end_date?new Date(k.end_date):null;c&&!isNaN(c.getTime())?(c.setHours(23,59,59,999),s=s.filter(m=>{const n=m[i];if(!n)return!1;const a=new Date(n);return!isNaN(a.getTime())&&a>=u&&a<=c})):s=s.filter(m=>{const n=m[i];if(!n)return!1;const a=new Date(n);return!isNaN(a.getTime())&&a>=u})}}else if(r==="end_date"&&i&&!k.start_date){const u=new Date(f);isNaN(u.getTime())||(u.setHours(23,59,59,999),s=s.filter(c=>{const m=c[i];if(!m)return!1;const n=new Date(m);return!isNaN(n.getTime())&&n<=u}))}else if(r.endsWith("_start")||r.endsWith("_min")||r.endsWith("_end")||r.endsWith("_max")){const u=r.endsWith("_start")||r.endsWith("_end"),c=r.endsWith("_start")||r.endsWith("_min"),m=r.substring(0,r.lastIndexOf("_"));s=s.filter(n=>{const a=n[m];if(a===null||typeof a>"u")return!1;if(u){const e=new Date(a),t=new Date(f);return isNaN(e.getTime())||isNaN(t.getTime())?!1:c?e>=t:e<=t}else{const e=parseFloat(a),t=parseFloat(f);return isNaN(e)||isNaN(t)?!1:c?e>=t:e<=t}})}else if(Array.isArray(f)){const u=f.map(String);s=s.filter(c=>{const m=c[r];return m!==null&&typeof m<"u"&&u.includes(String(m))})}else if(typeof f=="boolean")s=s.filter(u=>{let c=u[r];return typeof c=="string"&&(c.toLowerCase()==="true"?c=!0:c.toLowerCase()==="false"&&(c=!1)),c===f});else if(r!=="start_date"&&r!=="end_date"){const u=Array.isArray(o)?o.find(m=>m.name===r):null;if((u==null?void 0:u.type)==="number"||typeof f=="number"&&!isNaN(f))s=s.filter(m=>{const n=parseFloat(m[r]),a=parseFloat(f);return!isNaN(n)&&n===a});else{const m=String(f).toLowerCase();s=s.filter(n=>{const a=n[r];return a&&String(a).toLowerCase().includes(m)})}}}return s}export{Ne as D,$e as _,Ve as a};
