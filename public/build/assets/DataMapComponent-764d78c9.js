import{Q as ue,g as M,B as pe,m as g,z as ce,q as Q,o as u,d as v,u as me,b as s,e as b,h as S,k as N,G as ge,t as h,f as K,a as G,F as W,j as X,c as H,s as ve,l as Z,x as Y,p as fe}from"./app-59f66305.js";import{D as ye,_ as be,a as he}from"./MapToolbar.vue_vue_type_style_index_0_scoped_37465a74_lang-6dcbc018.js";import{A as xe}from"./AiAssistant-9112a77e.js";import{G as Fe}from"./SubscriptionBanner.vue_vue_type_style_index_0_scoped_7aa2f15c_lang-67917262.js";import{_ as we}from"./_plugin-vue_export-helper-c27b6911.js";const Ce={class:"data-map-container p-4"},Se={key:0,class:"mb-4 text-right"},_e={key:1,class:"nlp-query-section mb-6 p-4 border rounded-md shadow-sm bg-white"},De={class:"flex items-center space-x-2"},Me=["placeholder"],Oe=["disabled"],Pe={key:0,class:"mt-2 text-red-500 text-sm"},ke={key:1,class:"mt-2 text-sm text-indigo-500"},Re={class:"p-4 border rounded-md shadow-sm bg-white"},Ne={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Te={for:"clusterRadius",class:"block text-sm font-medium text-gray-700"},je={class:"font-bold"},Ve={class:"mb-6"},Ie={class:"selected-item-details p-4 border rounded-md shadow-sm bg-white mb-6 max-h-[40vh] overflow-y-auto"},Ue={key:0,class:"text-sm"},Ae={class:"capitalize"},$e={key:0},Je={key:1},Le={key:1,class:"text-gray-500"},ze={class:"mt-6 text-right"},qe=["disabled"],Ee={key:4,class:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center z-50"},Be={class:"bg-white p-6 rounded-lg shadow-xl w-full max-w-md"},Qe={class:"mb-4"},Ke={class:"mb-4"},Ge={class:"mb-4 border-t pt-4"},We={class:"max-h-40 overflow-y-auto space-y-1"},Xe=["value"],He={class:"mb-4"},Ze={class:"mb-4"},Ye={class:"inline-flex items-center"},et={key:0,class:"mb-4 text-sm text-red-500"},tt={class:"flex justify-end space-x-2"},at=["disabled"],lt={__name:"DataMapComponent",props:{initialDataProp:Array,pageFiltersProp:Object,dataTypeProp:String,dataTypeConfigProp:Object,isReadOnly:{type:Boolean,default:!1},initialMapSettings:{type:Object,default:()=>({center:[42.3601,-71.0589],zoom:12})},configurableFilterFieldsForView:{type:Array,default:()=>[]},mapConfiguration:Object,initialClusterRadiusProp:{type:[Number,String],default:80},defaultFilters:{type:Object,default:()=>({})}},setup(f){var B;const l=f,J=ue(),L=M(()=>{var t;return J.props.csrf_token||((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))});pe("translations");const y=g(null),p=g([]),C=g([]),c=g({}),O=g(""),_=g(""),P=g(!1),x=g(80),k=g(null),F=g((B=l.initialMapSettings)==null?void 0:B.center),w=g(!1),V=g(!1),T=g(!1),d=g({name:"",description:"",creator_display_name:"",map_type:"single",data_type:"",filters:{},map_settings:{},is_public:!1,configurable_filter_fields:[]}),R=g(!1),D=g(""),I=g(["en-US"]),ee=M(()=>{var t,e;return((t=l.dataTypeConfigProp)==null?void 0:t.humanName)||((e=l.dataTypeProp)==null?void 0:e.replace(/_/g," ").replace(/\b\w/g,n=>n.toUpperCase()))||"Data"}),te=M(()=>{const t=I.value[0]||"en-US";return{"en-US":"en","es-MX":"es"}[t]||"en"}),ae=M(()=>{var e;let t=(e=l.dataTypeConfigProp)==null?void 0:e.filterFieldsDescription;if(typeof t=="string")try{t=JSON.parse(t)}catch{return[]}return t?Array.isArray(t)?t:typeof t=="object"&&t!==null?Object.entries(t).map(([n,i])=>({name:n,label:i.label||n.replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase()),type:i.type||"text",options:i.options||[]})):[]:[]}),U=M(()=>l.isReadOnly?C.value:p.value),z=M(()=>{var n;let t=[],e=(n=l.dataTypeConfigProp)==null?void 0:n.filterFieldsDescription;if(e){if(typeof e=="string")try{e=JSON.parse(e)}catch{e=[]}Array.isArray(e)?t=e:typeof e=="object"&&e!==null&&(t=Object.entries(e).map(([i,a])=>({name:i,label:a.label||i.replace(/_/g," ").replace(/\b\w/g,r=>r.toUpperCase()),type:a.type||"text",options:a.options||[],...typeof a=="object"&&a!==null&&a})))}if(!l.isReadOnly)return t;if(l.configurableFilterFieldsForView&&l.configurableFilterFieldsForView.length>0){const i=new Set(l.configurableFilterFieldsForView);return t.filter(a=>i.has(a.name))}return t}),A=async t=>{var e,n,i;if(l.isReadOnly){$(t);return}if(l.dataTypeProp){w.value=!0,_.value="";try{const r=(await Y.post(`/api/data/${l.dataTypeProp}`,{filters:t},{headers:{"X-CSRF-TOKEN":L.value}})).data.data||[];if(p.value=r,l.isReadOnly&&(C.value=r),p.value.length>0&&!l.isReadOnly&&V.value&&(e=y.value)!=null&&e.getMapInstance()){const o=p.value.find(m=>(m.latitude||m.lat)&&(m.longitude||m.long||m.lng));if(o){const m=parseFloat(o.latitude||o.lat),j=parseFloat(o.longitude||o.long||o.lng);!isNaN(m)&&!isNaN(j)&&(F.value=[m,j],y.value.getMapInstance().setView(F.value,13))}}}catch(a){console.error(`Error fetching ${l.dataTypeProp} data:`,a),_.value=`Failed to fetch data. ${((i=(n=a.response)==null?void 0:n.data)==null?void 0:i.error)||a.message}`,p.value=[]}finally{w.value=!1,P.value=!1}}},q=async()=>{var t,e,n;if(!(l.isReadOnly||!O.value.trim()||!l.dataTypeProp)){w.value=!0,P.value=!0,_.value="";try{const i=await Y.post(`/api/natural-language-query/${l.dataTypeProp}`,{query:O.value},{headers:{"X-CSRF-TOKEN":L.value}}),a=i.data.data||[];if(p.value=a,l.isReadOnly&&(C.value=a),i.data.filtersApplied&&(c.value={...i.data.filtersApplied}),p.value.length>0&&V.value&&((t=y.value)!=null&&t.getMapInstance())){const r=p.value.find(o=>(o.latitude||o.lat)&&(o.longitude||o.long||o.lng));if(r){const o=parseFloat(r.latitude||r.lat),m=parseFloat(r.longitude||r.long||r.lng);!isNaN(o)&&!isNaN(m)&&(F.value=[o,m],y.value.getMapInstance().setView(F.value,13))}}}catch(i){console.error(`Error processing NLP query for ${l.dataTypeProp}:`,i),_.value=`NLP query failed. ${((n=(e=i.response)==null?void 0:e.data)==null?void 0:n.error)||i.message}`,p.value=[]}finally{w.value=!1,P.value=!1}}},$=t=>{var n,i,a;if(!l.isReadOnly)return;console.log("[DataMapComponent] Applying client-side filters:",JSON.parse(JSON.stringify(t)));const e={dateField:(n=l.dataTypeConfigProp)==null?void 0:n.dateField,searchableColumns:((i=l.dataTypeConfigProp)==null?void 0:i.searchableColumns)||[],filterFieldsDescription:(a=l.dataTypeConfigProp)==null?void 0:a.filterFieldsDescription};C.value=he(l.initialDataProp||[],t,e),console.log(`[DataMapComponent] Filtering complete. ${C.value.length} points remaining.`)},le=t=>{c.value={...t},l.isReadOnly?$(c.value):A(c.value)},se=t=>{k.value=t},ie=t=>{var i;k.value=t;const e=parseFloat(t.latitude||t.lat),n=parseFloat(t.longitude||t.long||t.lng);y.value&&!isNaN(e)&&!isNaN(n)&&y.value.panToAndOpenPopup(t,((i=l.dataTypeConfigProp)==null?void 0:i.externalIdField)||"id")},E=t=>{if(t===null||typeof t>"u")return"";let e=String(t);return e.includes(",")||e.includes('"')||e.includes(`
`)?(e=e.replace(/"/g,'""'),`"${e}"`):e},ne=()=>{if(p.value.length===0)return;const t=Object.keys(p.value[0]||{}),n=[t.map(E).join(","),...p.value.map(o=>t.map(m=>E(o[m])).join(","))].join(`
`),i=new Blob([n],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),r=URL.createObjectURL(i);a.setAttribute("href",r),a.setAttribute("download",`${l.dataTypeProp}_data.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)},oe=async()=>{var i,a,r;if(l.isReadOnly)return;R.value=!0,D.value="";const t=(i=y.value)==null?void 0:i.getMapInstance();let e=l.initialMapSettings.center,n=l.initialMapSettings.zoom;t&&(e=[t.getCenter().lat,t.getCenter().lng],n=t.getZoom()),d.value.data_type=l.dataTypeProp,d.value.filters={...c.value},d.value.map_settings={center:e,zoom:n};try{fe.post(route("saved-maps.store"),d.value,{onSuccess:()=>{T.value=!1,d.value.name="",d.value.description="",d.value.creator_display_name="",d.value.is_public=!1},onError:o=>{const m=Object.keys(o);m.length>0?D.value=o[m[0]]:D.value="An unknown error occurred while saving the map.",console.error("Error saving map:",o)},onFinish:()=>{R.value=!1}})}catch(o){console.error("Failed to save map:",o),D.value=((r=(a=o.response)==null?void 0:a.data)==null?void 0:r.message)||"Failed to save map.",R.value=!1}};ce(()=>{var r,o;console.log("[DataMapComponent] Mounted. Initializing...");const t={...l.defaultFilters||{},...l.pageFiltersProp||{}};console.log("[DataMapComponent] Received Props:",{isReadOnly:l.isReadOnly,initialDataCount:(r=l.initialDataProp)==null?void 0:r.length,pageFilters:JSON.parse(JSON.stringify(l.pageFiltersProp)),defaultFilters:JSON.parse(JSON.stringify(l.defaultFilters)),combinedFilters:JSON.parse(JSON.stringify(t)),clusterRadiusProp:l.initialClusterRadiusProp,initialMapSettings:JSON.parse(JSON.stringify(l.initialMapSettings))}),F.value=(o=l.initialMapSettings)==null?void 0:o.center;const n=t.clusterRadius??l.initialClusterRadiusProp,i=parseInt(n,10);x.value=isNaN(i)?80:i,delete t.clusterRadius;const a=l.initialDataProp||[];p.value=a,c.value=t,console.log("[DataMapComponent] Initial currentFilters set (clusterRadius excluded):",JSON.parse(JSON.stringify(c.value))),console.log(`[DataMapComponent] Cluster radius initialized to: ${x.value}`),l.isReadOnly?(C.value=a,console.log(`[DataMapComponent] Read-only mode. Initial clientFilteredDataPoints count: ${C.value.length}`),$(c.value)):(c.value.limit===void 0&&(c.value.limit=1e3),(Object.keys(c.value).filter(j=>j!=="limit").length>0||p.value.length===0)&&A(c.value))});const re=((t,e)=>{let n;return function(...i){clearTimeout(n),n=setTimeout(()=>t.apply(this,i),e)}})(()=>{const t={...c.value};t.clusterRadius=x.value,Object.keys(t).forEach(i=>{const a=t[i];(a===null||a===""||Array.isArray(a)&&a.length===0)&&delete t[i]});const e=new URLSearchParams(t).toString(),n=`${window.location.pathname}${e?`?${e}`:""}`;window.history.replaceState({path:n},"",n)},300);Q([c,x],()=>{re()},{deep:!0});const de=t=>{var n;V.value=!0;const e=((n=l.initialMapSettings)==null?void 0:n.zoom)||13;F.value&&t&&t.setView(F.value,e),l.isReadOnly&&p.value.length>0&&y.value};return Q(()=>l.dataTypeProp,(t,e)=>{t!==e&&!l.isReadOnly&&(O.value="",k.value=null,c.value={limit:1e3},d.value.configurable_filter_fields=[],A(c.value))}),(t,e)=>{var n,i;return u(),v("div",Ce,[!f.isReadOnly&&me(J).props.auth.user?(u(),v("div",Se,[s("button",{onClick:e[0]||(e[0]=a=>T.value=!0),class:"p-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600"}," Save Current Map View ")])):b("",!0),f.isReadOnly?b("",!0):(u(),v("div",_e,[e[9]||(e[9]=s("h3",{class:"text-xl font-semibold mb-3"},"Natural Language Query",-1)),e[10]||(e[10]=s("p",{class:"text-sm text-gray-600 mb-2"},` Ask a question about the data (e.g., "Show all incidents last week", "Find entries related to 'vandalism' in January"). `,-1)),s("div",De,[S(s("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>O.value=a),type:"text",placeholder:`Query ${ee.value} data...`,class:"p-2 border rounded-md w-full text-sm",onKeyup:ge(q,["enter"])},null,40,Me),[[N,O.value]]),s("button",{onClick:q,class:"p-2 bg-indigo-500 text-white rounded-md text-sm hover:bg-indigo-600 whitespace-nowrap",disabled:w.value},h(w.value&&P.value?"Processing...":"Submit Query"),9,Oe)]),_.value?(u(),v("div",Pe,h(_.value),1)):b("",!0),w.value&&P.value?(u(),v("div",ke,"Fetching data based on your query...")):b("",!0)])),s("div",Re,[e[13]||(e[13]=s("h3",{class:"text-xl font-semibold mb-3"},"Map Controls",-1)),s("div",Ne,[s("div",null,[s("label",Te,[e[11]||(e[11]=K(" Clustering Distance: ")),s("span",je,h(x.value)+"px",1)]),e[12]||(e[12]=s("p",{class:"text-xs text-gray-500 mb-1"},"Larger values group more markers together.",-1)),S(s("input",{type:"range",id:"clusterRadius",min:"0",max:"150",step:"5","onUpdate:modelValue":e[2]||(e[2]=a=>x.value=a),class:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"},null,512),[[N,x.value,void 0,{number:!0}]])])])]),s("div",Ve,[G(ye,{ref_key:"dataMapDisplayRef",ref:y,mapCenterCoordinates:F.value,dataPointsToDisplay:U.value,externalIdFieldProp:((n=f.dataTypeConfigProp)==null?void 0:n.externalIdField)||"id",mapConfiguration:f.mapConfiguration,dataTypeConfigProp:f.dataTypeConfigProp,clusterRadiusProp:x.value,onMarkerDataPointClicked:se,onMapInitializedInternal:de,class:"h-[70vh] w-full rounded-md shadow-md generic-map"},null,8,["mapCenterCoordinates","dataPointsToDisplay","externalIdFieldProp","mapConfiguration","dataTypeConfigProp","clusterRadiusProp"])]),s("div",Ie,[e[14]||(e[14]=s("h3",{class:"text-lg font-semibold mb-3"},"Selected Item Details",-1)),k.value?(u(),v("div",Ue,[(u(!0),v(W,null,X(k.value,(a,r)=>(u(),v("div",{key:r,class:"mb-1"},[s("strong",Ae,h(r.replace(/_/g," "))+":",1),typeof a=="object"?(u(),v("span",$e,h(JSON.stringify(a)),1)):(u(),v("span",Je,h(a),1))]))),128))])):(u(),v("div",Le,"Click a marker or list item to see details."))]),!f.isReadOnly||f.isReadOnly&&z.value.length>0?(u(),H(be,{key:2,"filter-fields-description":z.value,"initial-filters":c.value,"date-field":(i=f.dataTypeConfigProp)==null?void 0:i.dateField,"data-type":f.dataTypeProp,"is-read-only":f.isReadOnly,onFiltersUpdated:le,class:"mb-6"},null,8,["filter-fields-description","initial-filters","date-field","data-type","is-read-only"])):b("",!0),p.value.length>0&&!w.value&&!f.isReadOnly?(u(),H(xe,{key:3,context:U.value,language_codes:I.value,currentMapLanguage:te.value,class:"my-6"},null,8,["context","language_codes","currentMapLanguage"])):b("",!0),G(Fe,{totalData:U.value,itemsPerPage:10,onHandleGotoMarker:ie,language_codes:I.value,class:"mt-6"},null,8,["totalData","language_codes"]),s("div",ze,[f.isReadOnly?b("",!0):(u(),v("button",{key:0,onClick:ne,class:"p-2 bg-green-500 text-white rounded-md text-sm hover:bg-green-600",disabled:p.value.length===0}," Download Displayed Data as CSV ",8,qe))]),T.value?(u(),v("div",Ee,[s("div",Be,[e[22]||(e[22]=s("h3",{class:"text-lg font-semibold mb-4"},"Save Map",-1)),s("form",{onSubmit:ve(oe,["prevent"])},[s("div",Qe,[e[15]||(e[15]=s("label",{for:"mapName",class:"block text-sm font-medium text-gray-700"},"Map Name*",-1)),S(s("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=a=>d.value.name=a),id:"mapName",required:"",class:"mt-1 p-2 border rounded-md w-full"},null,512),[[N,d.value.name]])]),s("div",Ke,[e[16]||(e[16]=s("label",{for:"mapDescription",class:"block text-sm font-medium text-gray-700"},"Description",-1)),S(s("textarea",{"onUpdate:modelValue":e[4]||(e[4]=a=>d.value.description=a),id:"mapDescription",rows:"3",class:"mt-1 p-2 border rounded-md w-full"},null,512),[[N,d.value.description]])]),s("div",Ge,[e[17]||(e[17]=s("h4",{class:"text-sm font-medium text-gray-700 mb-2"},"Configurable Filters for Viewers:",-1)),e[18]||(e[18]=s("p",{class:"text-xs text-gray-500 mb-2"},"Select which filters viewers of this saved map can adjust (client-side).",-1)),s("div",We,[(u(!0),v(W,null,X(ae.value,a=>(u(),v("label",{key:a.name,class:"flex items-center text-sm"},[S(s("input",{type:"checkbox",value:a.name,"onUpdate:modelValue":e[5]||(e[5]=r=>d.value.configurable_filter_fields=r),class:"form-checkbox h-4 w-4 text-indigo-600 mr-2"},null,8,Xe),[[Z,d.value.configurable_filter_fields]]),K(" "+h(a.label),1)]))),128))])]),s("div",He,[e[19]||(e[19]=s("label",{for:"creatorDisplayName",class:"block text-sm font-medium text-gray-700"},"Creator Display Name (Optional)",-1)),S(s("input",{type:"text","onUpdate:modelValue":e[6]||(e[6]=a=>d.value.creator_display_name=a),id:"creatorDisplayName",placeholder:"Leave blank to use your account name",class:"mt-1 p-2 border rounded-md w-full"},null,512),[[N,d.value.creator_display_name]]),e[20]||(e[20]=s("p",{class:"text-xs text-gray-500 mt-1"},"This name will be shown if the map is public.",-1))]),s("div",Ze,[s("label",Ye,[S(s("input",{type:"checkbox","onUpdate:modelValue":e[7]||(e[7]=a=>d.value.is_public=a),class:"form-checkbox h-5 w-5 text-indigo-600"},null,512),[[Z,d.value.is_public]]),e[21]||(e[21]=s("span",{class:"ml-2 text-sm text-gray-700"},"Make this map public?",-1))])]),D.value?(u(),v("div",et,h(D.value),1)):b("",!0),s("div",tt,[s("button",{type:"button",onClick:e[8]||(e[8]=a=>T.value=!1),class:"p-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400"},"Cancel"),s("button",{type:"submit",disabled:R.value,class:"p-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 disabled:opacity-50"},h(R.value?"Saving...":"Save Map"),9,at)])],32)])])):b("",!0)])}}},ut=we(lt,[["__scopeId","data-v-5ca35567"]]);export{ut as D};
